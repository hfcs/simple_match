name: Merge Gate

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  actions: write
  contents: read

jobs:
  gate:
    name: Merge Gate - dispatch and verify required checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Ensure verify script is executable
        run: |
          ls -la .github/scripts || true
          chmod +x .github/scripts/verify_required_workflows.sh || true

      - name: Dispatch required workflows for this ref
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          REF: ${{ github.ref_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          # Workflow filenames to dispatch (must match files under .github/workflows)
          WORKFLOWS=("flutter-tests.yml" "coverage.yml" "coverage-web.yml" "integration-tests.yml")
          for wf in "${WORKFLOWS[@]}"; do
            # Use branch ref (REF) when dispatching workflow_dispatch events â€” passing a raw commit SHA
            # is not accepted by the API for workflow_dispatch and can cause dispatch failures.
            echo "Dispatching workflow file: $wf for ref ${REF} (original sha=${SHA})"
            curl -s -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO}/actions/workflows/${wf}/dispatches" \
              -d "{\"ref\":\"${REF}\"}" || echo "dispatch failed for $wf (non-fatal)"
          done

      - name: Verify required workflows succeeded for this commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          .github/scripts/verify_required_workflows.sh "CI - Flutter tests" "Coverage (VM + Chrome)" "coverage-web" "Integration Tests"
