name: Check settings_view.dart coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-check-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Ensure LFS assets are present (diagnostic)
        run: |
          # Sometimes LFS pointers are fetched but not checked out into working tree;
          # explicitly pull LFS objects for assets to ensure files exist for flutter.
          if command -v git-lfs >/dev/null 2>&1; then
            echo "git-lfs present; pulling LFS files for assets"
            git lfs pull --include="assets/fonts/*" || true
          else
            echo "git-lfs not present in runner; attempting fallback pull via git lfs fetch && git lfs checkout"
            git lfs fetch --all || true
            git lfs checkout || true
          fi
          echo "Listing assets/fonts for debug"
          ls -la assets/fonts || true

      - name: "CI fallback: comment out missing font asset in pubspec"
        run: |
          # If the font file isn't present in the working tree (e.g. not committed),
          # comment out the explicit asset line so Flutter tests can run in CI.
          if [ ! -f assets/fonts/NotoSerifHK-wght.ttf ]; then
            echo "Font not found in repo; commenting out pubspec asset line for CI"
            # Use sed to replace the exact assets line with a commented marker. Keep a backup.
            sed -i.bak 's/^[[:space:]]*- assets\/fonts\/NotoSerifHK-wght.ttf/  # - assets\/fonts\/NotoSerifHK-wght.ttf (removed in CI)/' pubspec.yaml || true
            echo "Diff of pubspec.yaml after comment:";
            git --no-pager diff -- pubspec.yaml || true
          else
            echo "Font present; no pubspec change needed"
          fi

      - name: Install Flutter SDK (manual)
        run: |
          set -eux
          # Download and extract a pinned Flutter SDK to avoid action resolution issues
          FLUTTER_VERSION=3.9.2
          FLUTTER_ARCHIVE=flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
          FLUTTER_URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/${FLUTTER_ARCHIVE}"
          echo "Downloading Flutter from $FLUTTER_URL"
          # -f: fail on HTTP errors, -S: show errors, -L: follow redirects
          set +e
          curl -fSL -o /tmp/${FLUTTER_ARCHIVE} "$FLUTTER_URL"
          CURL_EXIT=$?
          set -e
          if [ $CURL_EXIT -eq 0 ]; then
            echo "Downloaded archive:" && ls -lh /tmp/${FLUTTER_ARCHIVE} || true
            echo "File type:" && file /tmp/${FLUTTER_ARCHIVE} || true
            # Verify we actually downloaded an xz-compressed archive and not an HTML error page
            if file /tmp/${FLUTTER_ARCHIVE} | grep -qi 'XZ compressed'; then
              echo "Extracting downloaded Flutter archive"
              tar -xJf /tmp/${FLUTTER_ARCHIVE} -C $HOME
            else
              echo "Downloaded file is not an xz archive; will fall back to git-clone method" >&2
            fi
          else
            echo "curl failed with exit code $CURL_EXIT; will fall back to git-clone method" >&2
          fi

          # If extraction did not produce $HOME/flutter, fall back to a shallow git clone of the tagged release
          if [ ! -d "$HOME/flutter/bin" ]; then
            echo "Falling back to git clone of flutter repo (tag: $FLUTTER_VERSION)"
            # Clone the stable branch as a fallback (tag/archived release may not be present)
            git clone --depth 1 --branch stable https://github.com/flutter/flutter.git $HOME/flutter
          fi

          # Persist flutter/bin to following steps by writing to $GITHUB_PATH
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "Flutter installed at $HOME/flutter"
          # Use the explicit path in this step (GITHUB_PATH only affects later steps)
          $HOME/flutter/bin/flutter --version
        shell: bash

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Check settings_view.dart coverage >= 95%
        run: |
          chmod +x tools/check_settings_view_coverage.sh
          tools/check_settings_view_coverage.sh

      # Optional: upload coverage artifacts for debugging when it fails
      - name: Upload coverage artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info
