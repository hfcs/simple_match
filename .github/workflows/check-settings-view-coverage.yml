name: Check settings_view.dart coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-check-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Install runner system packages
        run: |
          set -eux
          # Ensure tools required by the tests and LFS are present on the runner
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git-lfs poppler-utils xz-utils curl ca-certificates
          # Initialize git-lfs so later git lfs commands work reliably
          git lfs install --system || true
        shell: bash

      - name: Ensure LFS assets are present (diagnostic)
        run: |
          # Sometimes LFS pointers are fetched but not checked out into working tree;
          # explicitly pull LFS objects for assets to ensure files exist for flutter.
          if command -v git-lfs >/dev/null 2>&1; then
            echo "git-lfs present; pulling LFS files for assets"
            git lfs pull --include="assets/fonts/*" || true
          else
            echo "git-lfs not present in runner; attempting fallback pull via git lfs fetch && git lfs checkout"
            git lfs fetch --all || true
            git lfs checkout || true
          fi
          echo "Listing assets/fonts for debug"
          ls -la assets/fonts || true

      - name: Download NotoSerifHK font (if missing)
        run: |
          set -eux
          mkdir -p assets/fonts
          FONT_PATH=assets/fonts/NotoSerifHK-wght.ttf
          if [ -f "$FONT_PATH" ]; then
            echo "Font already present at $FONT_PATH"
          else
            echo "Downloading NotoSerifHK font to $FONT_PATH"
            curl -fSL -o "$FONT_PATH" "https://github.com/notofonts/noto-cjk/raw/refs/heads/main/google-fonts/NotoSerifHK%5Bwght%5D.ttf"
            echo "Downloaded font size:" && ls -lh "$FONT_PATH" || true
          fi

      - name: "CI fallback: comment out missing font asset in pubspec"
        run: |
          # If the font file isn't present in the working tree (e.g. not committed),
          # comment out the explicit asset line so Flutter tests can run in CI.
          if [ ! -f assets/fonts/NotoSerifHK-wght.ttf ]; then
            echo "Font not found in repo; commenting out pubspec asset line for CI"
            # Use sed to replace the exact assets line with a commented marker. Keep a backup.
            sed -i.bak 's/^[[:space:]]*- assets\/fonts\/NotoSerifHK-wght.ttf/  # - assets\/fonts\/NotoSerifHK-wght.ttf (removed in CI)/' pubspec.yaml || true
            echo "Diff of pubspec.yaml after comment:";
            git --no-pager diff -- pubspec.yaml || true
          else
            echo "Font present; no pubspec change needed"
          fi

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Flutter (action)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.9.2'
          cache: true

      - name: Verify Flutter
        run: flutter --version

      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.pub-cache/hosted
            ~/.pub-cache/git
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Check settings_view.dart coverage >= 95%
        run: |
          chmod +x tools/check_settings_view_coverage.sh
          tools/check_settings_view_coverage.sh

      # Optional: upload coverage artifacts for debugging when it fails
      - name: Upload coverage artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info
