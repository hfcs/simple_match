name: Coverage Diagnostics (Chrome watchdog)

on:
  workflow_dispatch:

jobs:
  web-test-watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Chrome (if missing)
        run: |
          set -eux
          if command -v google-chrome-stable >/dev/null 2>&1 || command -v google-chrome >/dev/null 2>&1; then
            echo "Chrome present; skipping install"
            command -v google-chrome-stable || command -v google-chrome || true
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates gnupg
          TMP_DEB="/tmp/google-chrome-stable_current_amd64.deb"
          wget -O "$TMP_DEB" "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
          sudo apt-get install -y --no-install-recommends "$TMP_DEB" || {
            sudo dpkg -i "$TMP_DEB" || true
            sudo apt-get install -f -y
          }
          rm -f "$TMP_DEB"

      - name: Install coverage tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov poppler-utils

      - name: Install dependencies
        run: flutter pub get

      - name: Run web tests in chunks with timeout and heartbeat
        env:
          CHROME_BIN: /usr/bin/google-chrome-stable
          CHUNKS: 1
          TIMEOUT_SECS: 1800
          FLUTTER_TEST_ARGS: --disable-dds
        run: |
          set -euxo pipefail
          mkdir -p coverage
          WEB_LOG=coverage/web_test_diag.log
          rm -f "$WEB_LOG"

          echo "Starting heartbeat logger (prints a timestamp and process snapshot every 20s)"
          (while true; do
             echo "HEARTBEAT: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$WEB_LOG"
             echo "--- process snapshot ---" >> "$WEB_LOG"
             ps aux | egrep "flutter|dart|chrome|chromium|test" | sed -n '1,120p' >> "$WEB_LOG" || true
             echo "--- end snapshot ---" >> "$WEB_LOG"
             sleep 20
           done) &
          HB_PID=$!

          # Run chunked web tests sequentially to limit concurrent memory pressure; collect diagnostics per chunk
            for i in $(seq 0 $((CHUNKS-1))); do
            echo "=== Running web chunk $i of $CHUNKS ===" | tee -a "$WEB_LOG"
            mkdir -p "test_artifacts/web_chunk_$i"
            # Use TIMEOUT_SECS (in seconds) to avoid premature kills; keep some kill-after slack
            timeout ${TIMEOUT_SECS}s ./scripts/run_web_tests_chunk.sh "$i" "$CHUNKS" "$(pwd)/test_artifacts/web_chunk_$i" >>"$WEB_LOG" 2>&1 || echo "chunk $i exit $?" >>"$WEB_LOG" || true

            # capture immediate system state after chunk
            echo "--- /proc/meminfo after chunk $i ---" >> "$WEB_LOG" || true
            if [ -r /proc/meminfo ]; then cat /proc/meminfo >>"$WEB_LOG"; else echo "no /proc/meminfo" >>"$WEB_LOG"; fi
            echo "--- ps top RSS after chunk $i ---" >> "$WEB_LOG" || true
            ps aux --sort=-rss | head -n 40 >>"$WEB_LOG" || true
            echo "--- last dmesg after chunk $i ---" >> "$WEB_LOG" || true
            dmesg --ctime | tail -n 200 >>"$WEB_LOG" || true
          done

          # stop heartbeat and capture additional diagnostics, then dump log tail
          kill $HB_PID || true
          sleep 1
          echo "--- ps aux snapshot after run ---" >> "$WEB_LOG" || true
          ps aux | egrep "flutter|dart|chrome|chromium|test" | sed -n '1,200p' >> "$WEB_LOG" || true
          echo "--- ss listening ports ---" >> "$WEB_LOG" || true
          ss -ltnp 2>/dev/null | sed -n '1,200p' >> "$WEB_LOG" || true
          echo "--- last 400 lines of full system dmesg (truncated) ---" >> "$WEB_LOG" || true
          dmesg | tail -n 400 >> "$WEB_LOG" || true
          echo "--- web test log (last 200 lines) ---"
          tail -n 200 "$WEB_LOG" || true

          # Collect any discovered coverage artifacts
          if [ -f coverage/lcov.info ]; then
            mv coverage/lcov.info coverage/lcov.chrome.info
            echo "Chrome coverage captured -> coverage/lcov.chrome.info"
          fi

          # If chunk-level coverage files exist, copy them into coverage/ for upload
          find test_artifacts -type f -name "coverage.lcov" -exec cp --parents {} coverage/ \; || true

      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: coverage-web-diagnostics
          path: |
            coverage/web_test_diag.log
            coverage/lcov.chrome.info
            coverage
