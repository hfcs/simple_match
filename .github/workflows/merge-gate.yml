name: Merge Gate

on:
  push:
    branches: [ main ]

permissions:
  actions: write
  contents: read

jobs:
  preflight:
    name: Preflight - validate reusable workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - name: Check workflow files exist and declare workflow_call
        run: |
          set -euo pipefail
          files=(.github/workflows/coverage.yml .github/workflows/coverage-web.yml)
          for f in "${files[@]}"; do
            echo "Checking $f"
            if [ ! -f "$f" ]; then
              echo "ERROR: missing $f" >&2
              exit 2
            fi
            if ! grep -q "workflow_call" "$f"; then
              echo "ERROR: $f does not declare workflow_call" >&2
              grep -n "^on:" -n "$f" || true
              exit 3
            fi
            echo "OK: $f contains workflow_call"
          done
      - name: Check via GitHub API (optional extra diagnostic)
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          for f in .github/workflows/coverage.yml .github/workflows/coverage-web.yml; do
            echo "API lookup: $f"
            status=$(curl -s -o /tmp/api_resp.txt -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/${REPO}/contents/${f}?ref=${{ github.ref_name }}")
            if [ "$status" -ne 200 ]; then
              echo "API lookup failed for $f: HTTP $status" >&2
              cat /tmp/api_resp.txt || true
              exit 4
            fi
            echo "API OK: $f"
          done
      - name: Upload preflight diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: preflight-diagnostics
          path: |
            /tmp/api_resp.txt

  flutter-tests:
    name: CI - Flutter tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Run common CI setup
        uses: ./.github/actions/ci-setup
        with:
          install_poppler: 'true'
          install_lcov: 'false'
          install_git_lfs: 'true'

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter unit tests
        run: flutter test --coverage

  coverage-controller:
    name: Coverage Controller (dispatch & poll)
    runs-on: ubuntu-latest
    needs: flutter-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Dispatch coverage workflows and poll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          OWNER=${REPO%/*}
          REPO_NAME=${REPO#*/}
          # call the reusable script to dispatch and poll the workflows in parallel
          chmod +x ./.github/scripts/dispatch_and_poll.sh
          ./.github/scripts/dispatch_and_poll.sh "$OWNER" "$REPO_NAME" "$REF" coverage.yml coverage-web.yml

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: coverage-web
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install pdftotext (poppler-utils)
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Run integration tests
        run: flutter test integration_test || true
