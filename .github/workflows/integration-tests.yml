name: Integration Tests

on:
  push:
    branches: [ main, fix/web-export-import ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  web_integration:
    name: Web integration (Chrome)
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - name: Ensure font asset available
        run: |
          if [ -f tool/download_fonts.sh ]; then
            echo "Running font downloader to ensure assets/fonts exists"
            bash tool/download_fonts.sh
          else
            echo "No font downloader script found at tool/download_fonts.sh; continuing"
          fi
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          # Use the Flutter channel rather than a Dart SDK version.
          # Provide the channel explicitly so the action resolves a
          # concrete Flutter SDK (avoids treating 'stable' as a literal
          # version string).
          channel: stable
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.pub-cache/hosted
            ~/.pub-cache/git
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Verify installed tools (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Flutter:" && flutter --version || true
          echo "pdftotext (poppler):" && pdftotext -v || echo "pdftotext not present"
          echo "git-lfs:" && git lfs --version || echo "git-lfs not present"

      - name: Install coverage tools (lcov, poppler-utils, git-lfs) (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov poppler-utils git-lfs
          git lfs install --system || true

      - name: Write CI diagnostics (Linux)
        if: runner.os == 'Linux'
        run: |
          set -eux
          out=ci-diagnostics.txt
          echo "=== CI Diagnostics: $(date -u) ===" > "$out"
          java -version 2>&1 | sed -n '1,5p' >> "$out" || true
          javac -version 2>&1 | sed -n '1,5p' >> "$out" || true
          flutter --version 2>&1 | sed -n '1,5p' >> "$out" || true
          pdftotext -v 2>&1 | sed -n '1,5p' >> "$out" || echo "pdftotext not installed" >> "$out"
          git lfs --version 2>&1 | sed -n '1,5p' >> "$out" || echo "git-lfs not installed" >> "$out"
          lcov --version 2>&1 | sed -n '1,5p' >> "$out" || echo "lcov not installed" >> "$out"

      - name: Upload CI diagnostics (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ci-diagnostics
          path: ci-diagnostics.txt

      - name: "Debug: show Java/Gradle info"
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version || true
          javac -version || true
          ./gradlew --version || true

      - name: Install dependencies
        run: flutter pub get

      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Enable web support
        run: flutter config --enable-web

      - name: Run web integration test (without device)
        env:
          CHROME_BIN: /usr/bin/google-chrome-stable
        run: |
          flutter doctor -v
          # Running the integration_test on hosted Linux runners with -d chrome
          # currently fails: "Web devices are not supported for integration
          # tests yet." Run the test without a device flag so it executes as a
          # regular widget/integration test on the VM. The test uses mocked
          # SharedPreferences and verifies UI behavior, so this is a safe
          # compromise for CI.
          flutter test integration_test/settings_view_web_integration_test.dart --verbose

  macos_integration:
    name: macOS integration
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Ensure font asset available
        run: |
          if [ -f tool/download_fonts.sh ]; then
            echo "Running font downloader to ensure assets/fonts exists"
            bash tool/download_fonts.sh
          else
            echo "No font downloader script found at tool/download_fonts.sh; continuing"
          fi

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Cache Pub packages (macOS)
        if: runner.os == 'macOS'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.pub-cache/hosted
            ~/.pub-cache/git
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Verify installed tools (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Flutter:" && flutter --version || true
          if command -v pdftotext >/dev/null 2>&1; then pdftotext -v; else brew list --versions poppler || echo "pdftotext/poppler not present"; fi
echo "git-lfs:" && git lfs --version || echo "git-lfs not present"

      - name: Install coverage tools (macOS)
        if: runner.os == 'macOS'
        run: |
          if ! command -v lcov >/dev/null 2>&1; then
            brew update || true
            brew install lcov || true
          fi
          if ! command -v pdftotext >/dev/null 2>&1; then
            brew install poppler || true
          fi
          if ! command -v git-lfs >/dev/null 2>&1; then
            brew install git-lfs || true
            git lfs install --system || true
          fi

      - name: Write CI diagnostics (macOS)
        if: runner.os == 'macOS'
        run: |
          set -eux
          out=ci-diagnostics.txt
          echo "=== CI Diagnostics: $(date -u) ===" > "$out"
          java -version 2>&1 | sed -n '1,5p' >> "$out" || true
          javac -version 2>&1 | sed -n '1,5p' >> "$out" || true
          flutter --version 2>&1 | sed -n '1,5p' >> "$out" || true
          if command -v pdftotext >/dev/null 2>&1; then pdftotext -v 2>&1 | sed -n '1,5p' >> "$out"; else brew list --versions poppler >> "$out" || echo "pdftotext/poppler not present" >> "$out"; fi
git lfs --version 2>&1 | sed -n '1,5p' >> "$out" || echo "git-lfs not installed" >> "$out"

      - name: Upload CI diagnostics (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ci-diagnostics
          path: ci-diagnostics.txt

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Debug: show Java/Gradle info
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version || true
          javac -version || true
          ./gradlew --version || true

      - name: Install dependencies
        run: flutter pub get

      - name: Run macOS integration test
        run: |
          flutter doctor -v
          flutter test integration_test/settings_view_io_integration_test.dart -d macos --verbose
