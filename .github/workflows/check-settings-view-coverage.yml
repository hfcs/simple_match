name: Check settings_view.dart coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-check-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter SDK (manual)
        run: |
          set -eux
          # Download and extract a pinned Flutter SDK to avoid action resolution issues
          FLUTTER_VERSION=3.9.2
          FLUTTER_ARCHIVE=flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
          FLUTTER_URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/${FLUTTER_ARCHIVE}"
          echo "Downloading Flutter from $FLUTTER_URL"
          curl -sSLo /tmp/${FLUTTER_ARCHIVE} "$FLUTTER_URL"
          mkdir -p $HOME/flutter
          tar -xJf /tmp/${FLUTTER_ARCHIVE} -C $HOME
          export PATH="$HOME/flutter/bin:$PATH"
          echo "Flutter installed at $HOME/flutter"
          flutter --version
        shell: bash

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Check settings_view.dart coverage >= 95%
        run: |
          chmod +x tools/check_settings_view_coverage.sh
          tools/check_settings_view_coverage.sh

      # Optional: upload coverage artifacts for debugging when it fails
      - name: Upload coverage artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info
